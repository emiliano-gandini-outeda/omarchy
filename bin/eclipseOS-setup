#!/bin/bash

echo "=== Installing eclipseOS extra packages ==="
echo

AUR_PACKAGES=(
  "python-pyautogui"
  "vesktop"
  "clipse"
  "zen-browser-bin"
  "visual-studio-code-bin"
  "spicetify-themes"
  "github-desktop-bin"
)

sudo pacman -Sy

# Ensure yay exists
if ! command -v yay &> /dev/null; then
  echo "-> Installing yay..."
  sudo pacman -S --needed git base-devel
  git clone https://aur.archlinux.org/yay.git /tmp/yay
  cd /tmp/yay
  makepkg -si --noconfirm
  cd - >/dev/null
fi

yay -Sy

FAILED_PACKAGES=()

for package in "${AUR_PACKAGES[@]}"; do
  echo "-> Installing $package..."
  if ! yay -S --noconfirm "$package"; then
    echo "!! Failed to install $package"
    FAILED_PACKAGES+=("$package")
  fi
done

echo
echo "=== Configuring Spicetify ==="

SPOTIFY_PREFS="$HOME/.config/spotify/prefs"
SPOTIFY_INSTALL="/opt/spotify"

# Crear prefs falso si no existe
if [ ! -f "$SPOTIFY_PREFS" ]; then
    echo "-> Spotify prefs not found, creating a fake prefs..."
    mkdir -p "$(dirname "$SPOTIFY_PREFS")"
    touch "$SPOTIFY_PREFS"
fi

# Ajustar permisos para que Spicetify pueda escribir
if [ -d "$SPOTIFY_INSTALL" ]; then
    echo "-> Adjusting permissions for /opt/spotify..."
    sudo chown -R $USER:$USER "$SPOTIFY_INSTALL"
fi

# Initial backup & apply
spicetify backup apply

# Install Marketplace
curl -fsSL https://raw.githubusercontent.com/spicetify/spicetify-marketplace/main/resources/install.sh | sh

# Update Spicetify (themes/extensions)
spicetify update

# Apply final config
spicetify apply

echo
echo "✔ Done! All eclipseOS packages processed."

if [ ${#FAILED_PACKAGES[@]} -gt 0 ]; then
  echo
  echo "⚠ The following packages failed to install:"
  for pkg in "${FAILED_PACKAGES[@]}"; do
    echo " - $pkg"
  done
else
  echo "✓ All packages installed successfully!"
fi

echo
echo "Press ENTER to close..."
read

